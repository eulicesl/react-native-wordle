# Phase 1A: Critical Bug Fixes

These are blocking bugs that must be resolved before any new feature work. Each task is independent and can be completed in isolation.

## Context

- Game board: `src/screens/game/components/gameBoard.tsx`
- Letter tiles: `src/screens/game/components/letterSquare.tsx`
- Keyboard: `src/screens/game/components/keyboard.tsx`
- Game logic: `src/screens/game/index.tsx`
- Statistics screen: `src/screens/statistics/index.tsx`
- Achievement toast: `src/components/AchievementToast.tsx`
- Animation constants: `src/utils/animations.ts`

## Tasks

- [ ] F1.2a: Migrate gameBoard.tsx modal animation from RN Animated to Reanimated. The file currently imports `Animated as RNAnimated` from react-native (line 4) and uses `RNAnimated.Value`, `RNAnimated.timing`, `RNAnimated.spring` for the game-end modal fade and scale (lines 56-57, 94-106). Replace with Reanimated useSharedValue, useAnimatedStyle, withTiming, withSpring. The modal overlay opacity and content scale must animate identically: fade 0→1 over 300ms, spring scale 0.85→1 with tension 65 friction 10. Keep the setTimeout delay logic for showing the modal (line 91-108) but store the timeout ID in a useRef and clear it in useEffect cleanup. Remove the `RNAnimated` import entirely. Verify the Modal still opens and closes correctly by running the app.

- [ ] F1.2b: Migrate statistics/index.tsx tab indicator animation from RN Animated to Reanimated. The file imports `Animated` from react-native (line 11) and uses `new Animated.Value(0)` for the tab indicator (line 91), `Animated.spring` (line 140), and `Animated.View` (line 336). Replace with Reanimated useSharedValue, useAnimatedStyle, withSpring. The tab indicator translateX must interpolate from [0, 1, 2] to [0, tabIndicatorWidth, tabIndicatorWidth*2]. Also migrate the DistributionBar component (lines 443-481) which uses `new Animated.Value(0)` and `Animated.timing` for bar width animation. Replace with Reanimated withTiming and useAnimatedStyle. Remove the `Animated` and `Dimensions` imports from react-native after migration. Verify the Stats tab switcher and distribution bars still animate.

- [ ] F1.2c: Migrate AchievementToast.tsx from RN Animated to Reanimated. The file imports `Animated` from react-native (line 4) and uses `new Animated.Value(-120)` and `new Animated.Value(0)` for translateY and opacity (lines 43-44), `Animated.parallel`, `Animated.spring`, `Animated.timing` for slide-in and auto-dismiss animations (lines 55-82). Replace with Reanimated useSharedValue, useAnimatedStyle, withSpring, withTiming, withDelay. The slide-in should spring translateY from -120→0 (tension 80, friction 12) and fade opacity 0→1 over 200ms. The dismiss at 3 seconds should timing translateY 0→-120 over 300ms and opacity 1→0 over 300ms, then call onDismiss(). Store the dismiss timeout in useRef and clear in useEffect cleanup. Remove the `Animated` import from react-native.

- [ ] F1.3: Fix all setTimeout memory leaks in letterSquare.tsx. In letterSquare.tsx, the sound/haptic playback at line 132-138 uses `setTimeout(() => { ... }, TILE_FLIP_STAGGER_MS * idx)` without cleanup. If the component unmounts before the timeout fires (e.g., user navigates away), this will attempt to call functions on an unmounted component. Fix: create a `useRef<NodeJS.Timeout[]>` to store timeout IDs. Push each setTimeout return value to the ref. In a useEffect cleanup function, iterate the ref and call clearTimeout on each. Apply the same pattern to the error shake sound/haptic setTimeout if any exist. Also in src/screens/game/index.tsx, the setTimeout at line 329-331 (wrongGuessShake reset) and line 397 (game win delay) need the same treatment: store IDs in useRef, clear on unmount. Write a brief comment explaining why cleanup is needed.

- [ ] F1.4: Fix stale closure in handleFoundKeysOnKeyboard. In src/screens/game/index.tsx, the function `handleFoundKeysOnKeyboard` (lines 185-204) captures `usedKeys` from the component closure. When called inside setTimeout on line 352, the `usedKeys` value may be stale (captured from when the setTimeout was created, not when it fires). Fix: change the function to accept usedKeys as a parameter and pass the current value at the call site, OR use a useRef to always hold the latest usedKeys value. The useRef approach is preferred: create `const usedKeysRef = useRef(usedKeys)` and update it in a useEffect whenever usedKeys changes. Then read from usedKeysRef.current inside handleFoundKeysOnKeyboard. Verify keyboard key colors update correctly after a guess by checking that the correct/present/absent colors appear on the keyboard keys.

- [ ] F1.5a: Add React.memo to LetterSquare component. In src/screens/game/components/letterSquare.tsx, the LetterSquare component (line 45) re-renders on every Redux state change because it calls useAppSelector 3 times (lines 46-48, 49-51, 52). Wrap the component export with React.memo and provide a custom comparison function that only re-renders when the relevant props change (guess, letter, idx). The useAppSelector calls inside will still trigger re-renders on their own state changes, but the parent won't cause unnecessary re-renders. Also consider extracting the 3 useAppSelector calls into a single selector that returns a memoized object to reduce subscription overhead.

- [ ] F1.5b: Add React.memo to AnimatedKey component and memoize wordList. In src/screens/game/components/keyboard.tsx, wrap the AnimatedKey function component (line 50) with React.memo. It receives stable props but re-renders whenever the parent Keyboard component re-renders. Also in src/screens/game/index.tsx, the wordList function (lines 174-183) is wrapped in useCallback but still recreates the concatenated array every time it's called. Change it to useMemo so the concat only runs when gameLanguage changes: `const fullWordList = useMemo(() => { switch(gameLanguage) { case 'en': return wordsEN.concat(answersEN); case 'tr': return wordsTR.concat(answersTR); default: return wordsEN.concat(answersEN); } }, [gameLanguage]);`. Then use fullWordList directly instead of calling wordList(). Update the reference in checkGuess (line 398) from `wordList().includes(...)` to `fullWordList.includes(...)`.

- [ ] F1.5c: Add accessibilityViewIsModal to game-end modal. In src/screens/game/components/gameBoard.tsx, the game-end Modal component (line 201) does not trap focus for screen readers. Add `accessibilityViewIsModal={true}` to the modal content container (the RNAnimated.View at line 209, or after Reanimated migration, the equivalent Animated.View). This ensures VoiceOver/TalkBack users cannot navigate to elements behind the modal. Also add `accessible={true}` and `accessibilityRole="alert"` to the modal card container. Verify with VoiceOver that focus is trapped inside the modal when it appears.
